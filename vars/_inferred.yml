---
# Combine profiles and profiles_additions dictionaries
all_profiles: "{{ [profiles | default({}), profiles_additions | default({})] | combine(recursive=True, list_merge='prepend_rp') }}"

# Combine all profiles into a single combined dictionary to simplify tasks, if a control.add.profiles_list is provided only profiles specified are kept
combined_profile: "{{ (control.profiles_list | default(all_profiles.keys() | list)) | map('extract', all_profiles) | combine(recursive=True, list_merge='append_rp') }}"

add_packages: "{{ (combined_profile.package_manager_list is defined) and (combined_profile.package_manager_list != None) and (combined_profile.package_manager_list | length != 0) }}"
add_package_repos: "{{ (combined_profile.package_repos_list is defined) and (combined_profile.package_repos_list != None) and (combined_profile.package_repos_list | length != 0) }}"
add_flatpaks: "{{ (combined_profile.flatpak_packages_list is defined) and (combined_profile.flatpak_packages_list != None) and (combined_profile.flatpak_packages_list | length != 0) }}"
add_flatpak_repos: "{{ (combined_profile.flatpak_repos_list is defined) and (combined_profile.flatpak_repos_list != None) and (combined_profile.flatpak_repos_list | length != 0) }}"
add_snaps: "{{ (combined_profile.snap_packages_list is defined) and (combined_profile.snap_packages_list != None) and (combined_profile.snap_packages_list | length != 0) }}"
add_pips: "{{ (combined_profile.pip_packages_list is defined) and (combined_profile.pip_packages_list != None) and (combined_profile.pip_packages_list | length != 0) }}"
add_npms: "{{ (combined_profile.npm_packages_list is defined) and (combined_profile.npm_packages_list != None) and (combined_profile.npm_packages_list | length != 0) }}"
add_gems: "{{ (combined_profile.gem_packages_list is defined) and (combined_profile.gem_packages_list != None) and (combined_profile.gem_packages_list | length != 0) }}"